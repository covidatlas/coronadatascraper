import * as fetch from '../../lib/fetch.js';
import * as transform from '../../lib/transform.js';
import * as datetime from '../../lib/datetime.js';

// Set county to this if you only have state data, but this isn't the entire state
// const UNASSIGNED = '(unassigned)';

const scraper = {
  country: 'BRA',
  type: 'json',
  priority: 1,
  url: `http://plataforma.saude.gov.br/novocoronavirus/resources/scripts/database.js?v=${datetime.getYYYYMMDD()}`,
  timeseries: true,
  aggregate: 'county',
  maintainers: [
    {
      name: 'Felipe Roberto',
      email: 'contato@feliperoberto.com.br',
      // url: 'http://feliperoberto.com.br', // currently down
      github: 'feliperoberto',
      country: 'BRA',
      flag: 'üáßüá∑'
    }
  ],
  _dataIds: [
    {
      uid: 11,
      name: 'Rond√¥nia'
    },
    {
      uid: 12,
      name: 'Acre'
    },
    {
      uid: 13,
      name: 'Amazonas'
    },
    {
      uid: 14,
      name: 'Roraima'
    },
    {
      uid: 15,
      name: 'Par√°'
    },
    {
      uid: 16,
      name: 'Amap√°'
    },
    {
      uid: 17,
      name: 'Tocantins'
    },
    {
      uid: 21,
      name: 'Maranh√£o'
    },
    {
      uid: 22,
      name: 'Piau√≠'
    },
    {
      uid: 23,
      name: 'Cear√°'
    },
    {
      uid: 24,
      name: 'Rio Grande do Norte'
    },
    {
      uid: 25,
      name: 'Para√≠ba'
    },
    {
      uid: 26,
      name: 'Pernambuco'
    },
    {
      uid: 27,
      name: 'Alagoas'
    },
    {
      uid: 28,
      name: 'Sergipe'
    },
    {
      uid: 29,
      name: 'Bahia'
    },
    {
      uid: 31,
      name: 'Minas Gerais'
    },
    {
      uid: 32,
      name: 'Esp√≠rito Santo'
    },
    {
      uid: 33,
      name: 'Rio de Janeiro'
    },
    {
      uid: 35,
      name: 'S√£o Paulo'
    },
    {
      uid: 41,
      name: 'Paran√°'
    },
    {
      uid: 42,
      name: 'Santa Catarina'
    },
    {
      uid: 43,
      name: 'Rio Grande do Sul'
    },
    {
      uid: 50,
      name: 'Mato Grosso do Sul'
    },
    {
      uid: 51,
      name: 'Mato Grosso'
    },
    {
      uid: 52,
      name: 'Goi√°s'
    },
    {
      uid: 53,
      name: 'Distrito Federal'
    },
    {
      uid: 'PE',
      name: 'Peru'
    },
    {
      uid: 'GF',
      name: 'Guiana Francesa'
    },
    {
      uid: 'BF',
      name: 'Burkina Faso'
    },
    {
      uid: 'FR',
      name: 'Fran√ßa'
    },
    {
      uid: 'LY',
      name: 'Lib√©ria'
    },
    {
      uid: 'BY',
      name: 'Belarus'
    },
    {
      uid: 'PK',
      name: 'Paquist√£o'
    },
    {
      uid: 'ID',
      name: 'Indon√©sia'
    },
    {
      uid: 'YE',
      name: 'I√™men'
    },
    {
      uid: 'MG',
      name: 'Madagascar'
    },
    {
      uid: 'BO',
      name: 'Bol√≠via'
    },
    {
      uid: 'CI',
      name: 'Costa do Marfim'
    },
    {
      uid: 'DZ',
      name: 'Arg√©lia'
    },
    {
      uid: 'CH',
      name: 'Su√≠√ßa'
    },
    {
      uid: 'CM',
      name: 'Cameroun'
    },
    {
      uid: 'MK',
      name: 'Maced√¥nia do Norte'
    },
    {
      uid: 'BW',
      name: 'Botsuana'
    },
    {
      uid: 'UA',
      name: 'Ucr√¢nia'
    },
    {
      uid: 'KE',
      name: 'Qu√™nia'
    },
    {
      uid: 'TW',
      name: 'Taiwan'
    },
    {
      uid: 'JO',
      name: 'Jord√¢nia'
    },
    {
      uid: 'MX',
      name: 'M√©xico'
    },
    {
      uid: 'AE',
      name: 'Emirados √Årabes Unidos'
    },
    {
      uid: 'BZ',
      name: 'Belize'
    },
    {
      uid: 'BR',
      name: 'Brasil'
    },
    {
      uid: 'SL',
      name: 'Serra Leoa'
    },
    {
      uid: 'ML',
      name: 'Mali'
    },
    {
      uid: 'CD',
      name: 'Rep√∫blica Democr√°tica do Congo'
    },
    {
      uid: 'IT',
      name: 'It√°lia'
    },
    {
      uid: 'SO',
      name: 'Som√°lia'
    },
    {
      uid: 'AF',
      name: 'Afeganist√£o'
    },
    {
      uid: 'BD',
      name: 'Bangladesh'
    },
    {
      uid: 'DO',
      name: 'Rep√∫blica Dominicana'
    },
    {
      uid: 'GW',
      name: 'Guin√©-Bissau'
    },
    {
      uid: 'GH',
      name: 'Gana'
    },
    {
      uid: 'AT',
      name: '√Åustria'
    },
    {
      uid: 'SE',
      name: 'Su√©cia'
    },
    {
      uid: 'TR',
      name: 'Turquia'
    },
    {
      uid: 'UG',
      name: 'Uganda'
    },
    {
      uid: 'MZ',
      name: 'Mo√ßambique'
    },
    {
      uid: 'JP',
      name: 'Jap√£o'
    },
    {
      uid: 'NZ',
      name: 'Nova Zel√¢ndia'
    },
    {
      uid: 'CU',
      name: 'Cuba'
    },
    {
      uid: 'VE',
      name: 'Venezuela'
    },
    {
      uid: 'PT',
      name: 'Portugal'
    },
    {
      uid: 'CO',
      name: 'Col√¥mbia'
    },
    {
      uid: 'MR',
      name: 'Maurit√¢nia'
    },
    {
      uid: 'AO',
      name: 'Angola'
    },
    {
      uid: 'DE',
      name: 'Alemanha'
    },
    {
      uid: 'SD',
      name: 'Sud√£o'
    },
    {
      uid: 'TH',
      name: 'Tail√¢ndia'
    },
    {
      uid: 'AU',
      name: 'Austr√°lia'
    },
    {
      uid: 'PG',
      name: 'Papua Nova Guin√©'
    },
    {
      uid: 'IQ',
      name: 'Iraque'
    },
    {
      uid: 'HR',
      name: 'Cro√°cia'
    },
    {
      uid: 'GL',
      name: 'Groel√¢ndia'
    },
    {
      uid: 'NE',
      name: 'N√≠ger'
    },
    {
      uid: 'DK',
      name: 'Dinamarca'
    },
    {
      uid: 'LV',
      name: 'Let√¥nia'
    },
    {
      uid: 'RO',
      name: 'Rom√™nia'
    },
    {
      uid: 'ZM',
      name: 'Z√¢mbia'
    },
    {
      uid: 'IR',
      name: 'Ir√£'
    },
    {
      uid: 'MM',
      name: 'Myanmar'
    },
    {
      uid: 'ET',
      name: 'Eti√≥pia'
    },
    {
      uid: 'GT',
      name: 'Guatemala'
    },
    {
      uid: 'SR',
      name: 'Suriname'
    },
    {
      uid: 'EH',
      name: 'Saara Ocidental'
    },
    {
      uid: 'CZ',
      name: 'Rep√∫blica Tcheca'
    },
    {
      uid: 'TD',
      name: 'Chade'
    },
    {
      uid: 'AL',
      name: 'Alb√¢nia'
    },
    {
      uid: 'FI',
      name: 'Finl√¢ndia'
    },
    {
      uid: 'SY',
      name: 'S√≠ria'
    },
    {
      uid: 'KG',
      name: 'Quirguist√£o'
    },
    {
      uid: 'SB',
      name: 'Ilhas Salom√£o'
    },
    {
      uid: 'OM',
      name: 'Om√£'
    },
    {
      uid: 'PA',
      name: 'Panam√°'
    },
    {
      uid: 'AR',
      name: 'Argentina'
    },
    {
      uid: 'GB',
      name: 'Reino Unido'
    },
    {
      uid: 'CR',
      name: 'Costa Rica'
    },
    {
      uid: 'PY',
      name: 'Paraguai'
    },
    {
      uid: 'GN',
      name: 'Guin√©'
    },
    {
      uid: 'IE',
      name: 'Irlanda'
    },
    {
      uid: 'NG',
      name: 'Nig√©ria'
    },
    {
      uid: 'TN',
      name: 'Tun√≠sia'
    },
    {
      uid: 'PL',
      name: 'Pol√¥nia'
    },
    {
      uid: 'NA',
      name: 'Nam√≠bia'
    },
    {
      uid: 'ZA',
      name: '√Åfrica do Sul'
    },
    {
      uid: 'EG',
      name: 'Egito'
    },
    {
      uid: 'TZ',
      name: 'Tanz√¢nia'
    },
    {
      uid: 'GE',
      name: 'Ge√≥rgia'
    },
    {
      uid: 'SA',
      name: 'Ar√°bia Saudita'
    },
    {
      uid: 'VN',
      name: 'Vietn√£'
    },
    {
      uid: 'RU',
      name: 'R√∫ssia'
    },
    {
      uid: 'HT',
      name: 'Haiti'
    },
    {
      uid: 'BA',
      name: 'B√≥snia e Herzegovina'
    },
    {
      uid: 'IN',
      name: '√çndia'
    },
    {
      uid: 'CN',
      name: 'China'
    },
    {
      uid: 'CA',
      name: 'Canad√°'
    },
    {
      uid: 'SV',
      name: 'El Salvador'
    },
    {
      uid: 'GY',
      name: 'Guiana'
    },
    {
      uid: 'BE',
      name: 'B√©lgica'
    },
    {
      uid: 'GQ',
      name: 'Guin√© Equatorial'
    },
    {
      uid: 'LS',
      name: 'Lesoto'
    },
    {
      uid: 'BG',
      name: 'Bulg√°ria'
    },
    {
      uid: 'BI',
      name: 'Burundi'
    },
    {
      uid: 'DJ',
      name: 'Djibouti'
    },
    {
      uid: 'AZ',
      name: 'Azerbaij√£o'
    },
    {
      uid: 'MY',
      name: 'Mal√°sia'
    },
    {
      uid: 'PH',
      name: 'Filipinas'
    },
    {
      uid: 'UY',
      name: 'Uruguai'
    },
    {
      uid: 'CG',
      name: 'Rep√∫blica Democr√°tica do Congo'
    },
    {
      uid: 'RS',
      name: 'S√©rvia'
    },
    {
      uid: 'ME',
      name: 'Montenegro'
    },
    {
      uid: 'EE',
      name: 'Est√¥nia'
    },
    {
      uid: 'RW',
      name: 'Ruanda'
    },
    {
      uid: 'AM',
      name: 'Arm√™nia'
    },
    {
      uid: 'SN',
      name: 'Senegal'
    },
    {
      uid: 'TG',
      name: 'Togo'
    },
    {
      uid: 'ES',
      name: 'Espanha'
    },
    {
      uid: 'GA',
      name: 'Gab√£o'
    },
    {
      uid: 'HU',
      name: 'Hungria'
    },
    {
      uid: 'MW',
      name: 'Malawi'
    },
    {
      uid: 'TJ',
      name: 'Tajiquist√£o'
    },
    {
      uid: 'KH',
      name: 'Camboja'
    },
    {
      uid: 'KR',
      name: 'Coreia do Sul'
    },
    {
      uid: 'HN',
      name: 'Honduras'
    },
    {
      uid: 'IS',
      name: 'Isl√¢ndia'
    },
    {
      uid: 'NI',
      name: 'Nicar√°gua'
    },
    {
      uid: 'CL',
      name: 'Chile'
    },
    {
      uid: 'MA',
      name: 'Marrocos'
    },
    {
      uid: 'LR',
      name: 'Lib√©ria'
    },
    {
      uid: 'NL',
      name: 'Holanda'
    },
    {
      uid: 'CF',
      name: 'Rep√∫blica Centro-Africana'
    },
    {
      uid: 'SK',
      name: 'Eslov√°quia'
    },
    {
      uid: 'LT',
      name: 'Litu√¢nia'
    },
    {
      uid: 'ZW',
      name: 'Zimb√°bue'
    },
    {
      uid: 'LK',
      name: 'Sri Lanka'
    },
    {
      uid: 'IL',
      name: 'Israel'
    },
    {
      uid: 'LA',
      name: 'Laos'
    },
    {
      uid: 'KP',
      name: 'Coreia do Norte'
    },
    {
      uid: 'GR',
      name: 'Gr√©cia'
    },
    {
      uid: 'TM',
      name: 'Turcomenist√£o'
    },
    {
      uid: 'EC',
      name: 'Equador'
    },
    {
      uid: 'BJ',
      name: 'Benin'
    },
    {
      uid: 'SI',
      name: 'Eslov√™nia'
    },
    {
      uid: 'NO',
      name: 'Noruega'
    },
    {
      uid: 'MD',
      name: 'Mold√°via'
    },
    {
      uid: 'LB',
      name: 'L√≠bano'
    },
    {
      uid: 'NP',
      name: 'Nepal'
    },
    {
      uid: 'ER',
      name: 'Eritreia'
    },
    {
      uid: 'US',
      name: 'Estados Unidos'
    },
    {
      uid: 'KZ',
      name: 'Cazaquist√£o'
    },
    {
      uid: 'SZ',
      name: 'Suazil√¢ndia'
    },
    {
      uid: 'UZ',
      name: 'Uzbequist√£o'
    },
    {
      uid: 'MN',
      name: 'Mong√≥lia'
    },
    {
      uid: 'BT',
      name: 'But√£o'
    },
    {
      uid: 'NC',
      name: 'Nova Caled√¥nia'
    },
    {
      uid: 'FJ',
      name: 'Fiji'
    },
    {
      uid: 'KW',
      name: 'Kuwait'
    },
    {
      uid: 'TL',
      name: 'Timor-Leste'
    },
    {
      uid: 'BS',
      name: 'Bahamas'
    },
    {
      uid: 'VU',
      name: 'Vanuatu'
    },
    {
      uid: 'FK',
      name: 'Ilhas Malvinas'
    },
    {
      uid: 'GM',
      name: 'G√¢mbia'
    },
    {
      uid: 'QA',
      name: 'Catar'
    },
    {
      uid: 'JM',
      name: 'Jamaica'
    },
    {
      uid: 'CY',
      name: 'Chipre'
    },
    {
      uid: 'PR',
      name: 'Porto Rico'
    },
    {
      uid: 'PS',
      name: 'Palestina'
    },
    {
      uid: 'BN',
      name: 'Brunei'
    },
    {
      uid: 'TT',
      name: 'Trinidad e Tobago'
    },
    {
      uid: 'CV',
      name: 'Cabo Verde'
    },
    {
      uid: 'PF',
      name: 'Polin√©sia Francesa'
    },
    {
      uid: 'WS',
      name: 'Samoa'
    },
    {
      uid: 'LU',
      name: 'Luxemburgo'
    },
    {
      uid: 'RE',
      name: 'Ilha da Reuni√£o'
    },
    {
      uid: 'KM',
      name: 'Comores'
    },
    {
      uid: 'MU',
      name: 'Maur√≠cio'
    },
    {
      uid: 'FO',
      name: 'Ilhas Faro√©'
    },
    {
      uid: 'MQ',
      name: 'Martinica'
    },
    {
      uid: 'ST',
      name: 'S√£o Tom√© e Pr√≠ncipe'
    },
    {
      uid: 'AN',
      name: 'Antilhas Neerlandesas'
    },
    {
      uid: 'DM',
      name: 'Dominica'
    },
    {
      uid: 'GP',
      name: 'Guadalupe'
    },
    {
      uid: 'TO',
      name: 'Tonga'
    },
    {
      uid: 'KI',
      name: 'Quiribati'
    },
    {
      uid: 'FM',
      name: 'Micron√©sia'
    },
    {
      uid: 'BH',
      name: 'Bahrein'
    },
    {
      uid: 'AD',
      name: 'Andorra'
    },
    {
      uid: 'MP',
      name: 'Ilhas Marianas do Norte'
    },
    {
      uid: 'PW',
      name: 'Palau'
    },
    {
      uid: 'SC',
      name: 'Seicheles'
    },
    {
      uid: 'AG',
      name: 'Ant√≠gua e Barbuda'
    },
    {
      uid: 'BB',
      name: 'Barbados'
    },
    {
      uid: 'TC',
      name: 'Turks e Caicos'
    },
    {
      uid: 'VC',
      name: 'S√£o Vicente e Granadinas'
    },
    {
      uid: 'LC',
      name: 'Santa L√∫cia'
    },
    {
      uid: 'YT',
      name: 'Mayotte'
    },
    {
      uid: 'VI',
      name: 'Ilhas Virgens Americanas'
    },
    {
      uid: 'GD',
      name: 'Granada'
    },
    {
      uid: 'MT',
      name: 'Malta'
    },
    {
      uid: 'MV',
      name: 'Maldivas'
    },
    {
      uid: 'KY',
      name: 'Ilhas Cayman'
    },
    {
      uid: 'KN',
      name: 'S√£o Crist√≥v√£o e N√©vis'
    },
    {
      uid: 'MS',
      name: 'Montserrat'
    },
    {
      uid: 'NU',
      name: 'Niue'
    },
    {
      uid: 'PM',
      name: 'S√£o Pedro e Miquel√£o'
    },
    {
      uid: 'CK',
      name: 'Ilhas Cook'
    },
    {
      uid: 'WF',
      name: 'Wallis e Futuna'
    },
    {
      uid: 'AS',
      name: 'Samoa Americana'
    },
    {
      uid: 'MH',
      name: 'Ilhas Marshall'
    },
    {
      uid: 'AW',
      name: 'Aruba'
    },
    {
      uid: 'LI',
      name: 'Liechtenstein'
    },
    {
      uid: 'VG',
      name: 'Ilhas Virgens Brit√¢nicas'
    },
    {
      uid: 'SH',
      name: 'Santa Helena'
    },
    {
      uid: 'JE',
      name: 'Jersey'
    },
    {
      uid: 'AI',
      name: 'Anguilla'
    },
    {
      uid: 'GG',
      name: 'Guernsey'
    },
    {
      uid: 'SM',
      name: 'San Marino'
    },
    {
      uid: 'BM',
      name: 'Bermudas'
    },
    {
      uid: 'TV',
      name: 'Tuvalu'
    },
    {
      uid: 'NR',
      name: 'Nauru'
    },
    {
      uid: 'GI',
      name: 'Gibraltar'
    },
    {
      uid: 'PN',
      name: 'Ilhas Pitcairn'
    },
    {
      uid: 'MC',
      name: 'M√¥naco'
    },
    {
      uid: 'VA',
      name: 'Vaticano'
    },
    {
      uid: 'IM',
      name: 'Ilha de Man'
    },
    {
      uid: 'GU',
      name: 'Guam'
    },
    {
      uid: 'SG',
      name: 'Singapura'
    },
    {
      uid: 'SS',
      name: 'Sud√£o do Sul'
    },
    {
      uid: 'SX',
      name: 'S√£o Martinho'
    },
    {
      uid: 'BL',
      name: 'S√£o Bartolomeu'
    }
  ],
  _ufs: {
    Acre: ['AC', 881935, [-9.0238, -70.812]],
    Alagoas: ['AL', 3337357, [-9.5713, -36.782]],
    Amap√°: ['AP', 845731, [0.902, -52.003]],
    Amazonas: ['AM', 4144597, [-3.4168, -65.8561]],
    Bahia: ['BA', 14873064, [-12.5797, -41.7007]],
    Cear√°: ['CE', 9132078, [-5.4984, -39.3206]],
    'Distrito Federal': ['DF', 3015268, [-15.7998, -47.8645]],
    'Esp√≠rito Santo': ['ES', 4018650, [-19.1834, -40.3089]],
    Goi√°s: ['GO', 7018354, [-15.827, -49.8362]],
    Maranh√£o: ['MA', 7075181, [-4.9609, -45.2744]],
    'Mato Grosso': ['MT', 3484466, [-12.6819, -56.9211]],
    'Mato Grosso do Sul': ['MS', 2778986, [-20.7722, -54.7852]],
    'Minas Gerais': ['MG', 21168791, [-18.5122, -44.555]],
    Paran√°: ['PR', 11433957, [-25.2521, -52.0215]],
    Para√≠ba: ['PB', 4018127, [-7.24, -36.782]],
    Par√°: ['PA', 11433957, [-1.9981, -54.9306]],
    Pernambuco: ['PE', 9557071, [-8.8137, -36.9541]],
    Piau√≠: ['PI', 3273227, [-7.7183, -42.7289]],
    'Rio Grande do Norte': ['RN', 3506853, [-5.4026, -36.9541]],
    'Rio Grande do Sul': ['RS', 11377239, [-30.0346, -51.2177]],
    'Rio de Janeiro': ['RJ', 17264943, [-22.9099, -43.2095]],
    Rond√¥nia: ['RO', 1777225, [-11.5057, -63.5806]],
    Roraima: ['RR', 60576, [2.7376, -62.0751]],
    'Santa Catarina': ['SC', 7164788, [-27.2423, -50.2189]],
    Sergipe: ['SE', 2298696, [-10.5741, -37.3857]],
    'S√£o Paulo': ['SP', 45919049, [-23.5505, -46.6333]],
    Tocantins: ['TO', 1572866, [-10.1753, -48.2982]]
  },
  async scraper() {
    const scrapeDate = process.env.SCRAPE_DATE ? new Date(process.env.SCRAPE_DATE) : datetime.getDate();
    const ufs = this._ufs;
    const labels = {};
    const dataIds = this._dataIds;
    dataIds.forEach(label => {
      if (typeof label.uid === 'number') labels[label.uid] = ufs[label.name];
    });
    const data = await fetch.page(this.url, false);
    const dataJson = JSON.parse(data.text().replace('var database=', ''));
    const dataBrazil = [];

    // Find the latest available date
    const dateParts = dataJson.brazil[dataJson.brazil.length - 1].date.split('/');
    const latestDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);

    let targetDate;
    if (datetime.dateIsBefore(latestDate, scrapeDate)) {
      console.error('  üö® Timeseries for BRA has not been updated, using %s instead of %s', datetime.getYYYYMMDD(latestDate), datetime.getYYYYMMDD(scrapeDate));
      targetDate = datetime.getDDMMYYYY(latestDate, '/');
    } else {
      targetDate = datetime.getDDMMYYYY(scrapeDate, '/');
    }

    dataJson.brazil
      .filter(row => row.date === targetDate)
      .forEach(dateData => {
        dateData.values.forEach(value => {
          dataBrazil.push({
            state: labels[parseInt(value.uid, 10)][0],
            cases: value.cases || 0,
            deaths: value.deaths || 0,
            population: labels[parseInt(value.uid, 10)][1],
            coordinates: [labels[parseInt(value.uid, 10)][2][1], labels[parseInt(value.uid, 10)][2][0]]
          });
        });
      });
    dataBrazil.push(transform.sumData(dataBrazil));
    return dataBrazil;
  }
};

export default scraper;
